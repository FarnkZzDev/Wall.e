<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>Asistente AgroWall.E Grabador</title>
<style>
  :root{
    --bg:#0b1220; --card:#121a2b; --accent:#2ee6a6; --accent-2:#6ea8fe; --warn:#ff4d4f;
    --text:#e9eef7; --muted:#99a3b3; --ring:#1f2b45;
    --space:16px; --radius:20px; --font:15px; --h1:18px;
    --circle:84px; --stroke:10; --waveH:84px; --btnPad:12px;
  }
  .mini{ --space:10px; --radius:14px; --font:13px; --h1:16px; --circle:56px; --stroke:8; --waveH:56px; --btnPad:10px; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; color:var(--text);
        background: radial-gradient(1200px 600px at 60% -10%, #15203a, transparent 60%), var(--bg);
        display:flex; align-items:center; justify-content:center; padding:var(--space); }
  .app{ width:100%; max-width:520px; background:var(--card); border:1px solid var(--ring);
        border-radius:var(--radius); padding:calc(var(--space) + 2px) var(--space); box-shadow:0 20px 60px rgba(0,0,0,.35); }
  header{display:flex; align-items:center; gap:10px; margin-bottom:8px}
  .logo{width:32px; height:32px; border-radius:10px; background:conic-gradient(from 180deg, var(--accent), var(--accent-2)); box-shadow:0 0 0 6px rgba(46,230,166,.08);}
  h1{font-size:var(--h1); margin:0; line-height:1.2}
  p.sub{margin:2px 0 0; color:var(--muted); font-size:12px}
  .status{display:flex; align-items:center; justify-content:space-between; background:#0f1729; border:1px solid var(--ring); border-radius:12px; padding:8px 10px; margin-top:6px;}
  .dot{width:10px; height:10px; border-radius:999px; background:#94a3b8; margin-right:8px}
  .dot.recording{background:var(--warn); box-shadow:0 0 0 6px rgba(255,77,79,.12); animation:pulse 1s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,77,79,.35)}70%{box-shadow:0 0 0 12px rgba(255,77,79,0)}100%{box-shadow:0 0 0 0 rgba(255,77,79,0)}}
  .status-left{display:flex; align-items:center; gap:8px}
  .status-text{font-size:12px; color:var(--muted)}
  .timer{font-variant-numeric:tabular-nums; font-size:12px}
  .rec-area{margin:12px 0; display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;}
  .circle-wrap{position:relative; width:var(--circle); height:var(--circle)}
  .circle{transform:rotate(-90deg)}
  .circle-bg{stroke:#1e2a44; stroke-width:var(--stroke); fill:none}
  .circle-prog{stroke:var(--accent); stroke-linecap:round; stroke-width:var(--stroke); fill:none; transition:stroke-dashoffset .08s linear}
  .circle-center{position:absolute; inset:0; display:grid; place-items:center; font-size:12px; color:var(--muted)}
  .wave{height:var(--waveH); background:linear-gradient(180deg, #0f1830, #0b1427); border:1px dashed #25345a; border-radius:12px; display:flex; gap:6px; align-items:center; justify-content:center; overflow:hidden; transition:opacity .2s ease;}
  .bar{width:6px; height:24px; background:linear-gradient(180deg, var(--accent), #22c1d6); border-radius:6px; opacity:.85; transform:scaleY(.4);}
  .wave.recording .bar{ animation: wave 1s ease-in-out infinite; }
  .wave.recording .bar:nth-child(2){ animation-delay:.12s } .wave.recording .bar:nth-child(3){ animation-delay:.24s } .wave.recording .bar:nth-child(4){ animation-delay:.36s } .wave.recording .bar:nth-child(5){ animation-delay:.48s }
  @keyframes wave{0%,100%{transform:scaleY(.4)}50%{transform:scaleY(1.4)}}
  /* 4 columnas para incluir el bot√≥n Detener */
  .controls{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:4px;}
  button{appearance:none; border:1px solid var(--ring); background:#101a31; color:var(--text); padding:var(--btnPad) 8px; border-radius:12px; font-weight:600; font-size:var(--font); transition:transform .05s ease, background .2s ease, border-color .2s ease; touch-action:manipulation; min-height:40px;}
    /* üîí Evita selecci√≥n/menus y el flash de tap en m√≥viles */
  button, .btn, .controls button, .controls button * {
    user-select: none;
    -webkit-user-select: none;      /* iOS/Safari */
    -ms-user-select: none;          /* IE/Edge legado */
    -webkit-touch-callout: none;    /* sin men√∫ al mantener pulsado */
    -webkit-tap-highlight-color: transparent;
  }
  /* Para el bot√≥n de mantener pulsado, elimina todos los gestos t√°ctiles */
  #btnRecord { touch-action: none; }   /* evita que el scroll/zoom ‚Äúcancele‚Äù la pulsaci√≥n */
  button:active{transform:translateY(1px)}
  button.primary{background:linear-gradient(180deg, #173256, #0f2a48); border-color:#23406e}
  button.accent{background:linear-gradient(180deg, #1a3f39, #12362f); border-color:#205a4b}
  button.warn{background:linear-gradient(180deg, #3b1620, #2a0f17); border-color:#61222d}
  button:disabled{opacity:.55; filter:grayscale(.15); cursor:not-allowed}
  .mini .controls button span.text{display:none} .mini .controls button{min-height:38px}
  .preview{background:#0f1729; border:1px solid var(--ring); border-radius:12px; padding:8px; margin-top:8px;}
  .row{display:flex; align-items:center; gap:8px; justify-content:space-between}
  audio{width:100%; margin-top:4px}
  .hint{color:var(--muted); font-size:11px; margin-top:4px}
  .toast{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); background:#0f1729; border:1px solid var(--ring); color:var(--text); padding:8px 12px; border-radius:12px; font-size:12px; display:none; z-index:50}
  .toast.show{display:block}
  @media (max-width: 340px){ body{padding:8px} }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo"></div>
      <div>
        <h1>Asistente AgroWall.E</h1>
        <p class="sub">Mant√©n para grabar, revisa y env√≠a</p>
      </div>
    </header>

    <div class="status">
      <div class="status-left">
        <div class="dot" id="dot"></div>
        <div class="status-text" id="statusText">Listo para grabar</div>
      </div>
      <div class="timer" id="timer">0.0s</div>
    </div>

    <div class="rec-area">
      <div class="wave" id="wave" style="opacity:.7">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
      <div class="circle-wrap">
        <svg class="circle" id="circleSVG" width="84" height="84" viewBox="0 0 84 84">
          <circle class="circle-bg" cx="42" cy="42" r="34"></circle>
          <circle class="circle-prog" id="circleProg" cx="42" cy="42" r="34"></circle>
        </svg>
        <div class="circle-center"><span id="cap">0%</span></div>
      </div>
    </div>

    <div class="controls">
      <button id="btnRecord" class="primary" title="Mantener para grabar">üé§ <span class="text">Mantener</span></button>
      <button id="btnPlay" class="accent" disabled title="Escuchar">‚ñ∂Ô∏è <span class="text">Escuchar</span></button>
      <button id="btnSend" class="accent" disabled title="Enviar">üì§ <span class="text">Enviar</span></button>
    <!-- <button id="btnStop" class="warn" disabled title="Detener">üîá <span class="text">Detener</span></button>
      <button id="btnHumidity" class="accent" title="Obtener Humedad">üíß <span class="text">Humedad</span></button> -->
    </div>

    <div class="preview" id="preview" hidden>
      <div class="row">
        <strong>Previsualizaci√≥n</strong>
        <button id="btnRedo" class="warn" title="Regrabar">‚Ü∫ <span class="text">Regrabar</span></button>
      </div>
      <audio id="audio" controls></audio>
      
      <div class="hint">M√°x. 4.5 s. Si prefieres, regraba antes de enviar.</div>
    </div>
    
  </div>

  <div class="toast" id="toast">Enviando‚Ä¶</div>

<script>
  // ==== Config autodetectada ====
  const SERVER = window.location.origin;   // front y back en el mismo origen (8000)
  const ENDPOINT = "/qa";
  const MAX_SEC = 4.5;

  // Modo mini
  const params = new URLSearchParams(location.search);
  const forceMini = params.get('mini') === '1';
  function applyMini(){ document.documentElement.classList.toggle('mini', forceMini || window.innerWidth<=340); }
  applyMini(); addEventListener('resize', applyMini);

  // Refs / estado
  const dot = document.getElementById('dot'), statusText=document.getElementById('statusText'), timer=document.getElementById('timer');
  const circle=document.getElementById('circleProg'), cap=document.getElementById('cap'), wave=document.getElementById('wave');
  const btnRecord=document.getElementById('btnRecord'), btnPlay=document.getElementById('btnPlay'), btnSend=document.getElementById('btnSend'), btnRedo=document.getElementById('btnRedo');
  const btnStop=document.getElementById('btnStop');
  const audio=document.getElementById('audio'), preview=document.getElementById('preview'), toast=document.getElementById('toast');

  const MIME_CANDIDATES = [
    "audio/webm;codecs=opus",
    "audio/webm",
    "audio/mp4;codecs=mp4a.40.2", // iOS Safari
    "audio/mp4",
    "audio/ogg;codecs=opus",
    "audio/ogg"
  ];
  const pickMime = () => MIME_CANDIDATES.find(t => MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t));

  let state="idle", mediaStream=null, mediaRec=null, chunks=[], recording=false, startedAt=0, timerId=null, progId=null, audioBlob=null;
  const r=34, CIRC=2*Math.PI*r; circle.style.strokeDasharray=`${CIRC} ${CIRC}`; circle.style.strokeDashoffset=`${CIRC}`;
  const setProgress=p=>{ const off=CIRC-(p*CIRC); circle.style.strokeDashoffset=`${off}`; cap.textContent=`${Math.round(p*100)}%`; };
  const formatSec=s=>`${s.toFixed(1)}s`;
  const toastShow=(m,ms=1200)=>{ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), ms); };
  const stopPreviewAudio=()=>{ if(!audio.paused){ audio.pause(); audio.currentTime=0; } };
  const clearTimers=()=>{ if(timerId){clearInterval(timerId); timerId=null;} if(progId){clearInterval(progId); progId=null;} };

  function resetUI(){
    recording=false; audioBlob=null; chunks=[]; state="idle";
    statusText.textContent="Listo para grabar"; dot.classList.remove('recording'); wave.classList.remove('recording'); wave.style.opacity=.7;
    timer.textContent="0.0s"; setProgress(0);
    btnPlay.disabled=true; btnSend.disabled=true; btnRecord.disabled=false; btnStop.disabled=true;
    preview.hidden=true; clearTimers();
  }

  function isSupported() {
    return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  }
  function assertSecureAndSupported() {
    if (!isSupported()) { toastShow("Tu navegador no soporta getUserMedia", 2500); return false; }
    if (!window.isSecureContext) {
      toastShow("Abre esta p√°gina en HTTPS o desde localhost", 3000);
      statusText.textContent = "Contexto inseguro (usa HTTPS)";
      return false;
    }
    return true;
  }

  async function ensureMicOnce(){
    if (mediaStream) return true;
    try{
      state="requesting"; statusText.textContent="Pidiendo permiso de mic‚Ä¶";
      btnRecord.disabled=true; btnPlay.disabled=true; btnSend.disabled=true;

      mediaStream = await navigator.mediaDevices.getUserMedia({
        audio:{ echoCancellation:true, noiseSuppression:true, channelCount:1 }
      });

      statusText.textContent="Permiso concedido ‚úì";
      return true;
    }catch(e){
      console.error(e);
      let msg = "Permiso denegado o error de micr√≥fono";
      if (e.name === "NotAllowedError") msg = "Acceso al micr√≥fono denegado";
      if (e.name === "NotFoundError")  msg = "No se encontr√≥ micr√≥fono";
      if (e.name === "SecurityError")  msg = "Bloqueado por seguridad (¬øHTTPS?)";
      if (e.message?.includes("Only secure origins")) msg = "Requiere HTTPS";
      statusText.textContent = msg;
      toastShow(msg + " ‚Ä¢ Usa HTTPS y vuelve a intentar", 3000);
      return false;
    }finally{
      btnRecord.disabled = !mediaStream;
      btnPlay.disabled=true; btnSend.disabled=true; state="idle";
    }
  }

  async function startRec(){
    if(state!=="idle") return;
    if (!assertSecureAndSupported()) return;
    const ok = await ensureMicOnce(); if(!ok) return;

    const mime = pickMime();
    if (!mime){ alert("Tu navegador no soporta MediaRecorder compatible."); return; }

    stopPreviewAudio(); clearTimers(); setProgress(0);
    try{ mediaRec = new MediaRecorder(mediaStream, { mimeType:mime }); }
    catch(err){ console.error(err); statusText.textContent="No se pudo iniciar el grabador"; toastShow("Error al iniciar", 1400); return; }

    chunks=[]; mediaRec.ondataavailable=e=>{ if(e.data && e.data.size) chunks.push(e.data); };
    mediaRec.onstop=onStopped; mediaRec.onerror=ev=>{ console.error("MediaRecorder error:", ev.error); safeAbort("Error del grabador"); };

    recording=true; state="recording"; startedAt=performance.now();
    dot.classList.add('recording'); wave.classList.add('recording'); statusText.textContent="Grabando‚Ä¶"; wave.style.opacity=1;

    timerId=setInterval(()=>{ const s=Math.min((performance.now()-startedAt)/1000, MAX_SEC); timer.textContent=formatSec(s); },80);
    let lastP=0; progId=setInterval(()=>{ if(state!=="recording") return; const p=Math.min((performance.now()-startedAt)/1000/MAX_SEC,1); if(p!==lastP){ setProgress(p); lastP=p; } if(p>=1){ stopRec(); } },60);

    try{ mediaRec.start(10); }catch(e){ console.error(e); safeAbort("No se pudo iniciar la captura"); }
  }
  function stopRec(){
    if(state!=="recording") return;
    recording=false; state="processing"; dot.classList.remove('recording'); wave.classList.remove('recording'); wave.style.opacity=.7; statusText.textContent="Procesando‚Ä¶";
    clearTimers(); try{ mediaRec.stop(); }catch(_){ onStopped(); }
  }
  async function onStopped(){
    try{
      const blob = new Blob(chunks, { type:(mediaRec && mediaRec.mimeType) || "audio/webm" });
      audioBlob = blob; audio.src = URL.createObjectURL(blob);
      statusText.textContent="Listo para revisar"; btnPlay.disabled=false; btnSend.disabled=false; preview.hidden=false; btnRecord.disabled=true; state="ready";
    }catch(e){ console.error(e); safeAbort("Error al finalizar"); }
    finally{ mediaRec=null; clearTimers(); setProgress(1); }
  }
  function safeAbort(msg){
    console.warn("Abort:", msg); try{ if(mediaRec && mediaRec.state!=="inactive") mediaRec.stop(); }catch(_){}
    clearTimers(); dot.classList.remove('recording'); wave.classList.remove('recording'); wave.style.opacity=.7;
    statusText.textContent=msg; timer.textContent="0.0s"; setProgress(0);
    chunks=[]; recording=false; btnPlay.disabled=true; btnSend.disabled=true; btnRecord.disabled=false; btnStop.disabled=true; preview.hidden=true; state="idle"; toastShow(msg,1500);
  }

  // Botones
  btnRecord.addEventListener('pointerdown', async e=>{ if(btnRecord.disabled) return; e.preventDefault(); if(state==="ready") return; stopPreviewAudio(); clearTimers(); startRec(); });
  btnRecord.addEventListener('pointerup',   e=>{ e.preventDefault(); if(state==="recording") stopRec(); });
  btnRecord.addEventListener('pointerleave',e=>{ if(state==="recording") stopRec(); });
  btnPlay.addEventListener('click', ()=>{ if(audioBlob) audio.play(); });
  btnRedo.addEventListener('click', ()=>{ stopPreviewAudio(); resetUI(); toastShow("Listo para regrabar", 900); });

  // Enviar y reproducir por STREAM desde /play
  btnSend.addEventListener('click', async ()=>{
    if(!audioBlob || state!=="ready"){ toastShow("No hay audio para enviar", 1200); return; }
    try{
      stopPreviewAudio();
      statusText.textContent="Enviando‚Ä¶";
      toastShow("Enviando‚Ä¶", 900);
      btnSend.disabled=true;

      const ext = audioBlob.type.includes("mp4") ? "m4a"
                : audioBlob.type.includes("ogg") ? "ogg"
                : "webm";
      const fd = new FormData();
      fd.append("file", audioBlob, `grabacion.${ext}`);

      const rsp = await fetch(SERVER + ENDPOINT, { method:"POST", body: fd }); // SIN headers
      if(!rsp.ok) throw new Error("HTTP " + rsp.status);

      // Reproducir la respuesta desde /play (streaming)
      audio.src = SERVER + "/play?t=" + Date.now(); // cache-buster
      try { await audio.play(); btnStop.disabled = false; } catch(_) {}

      toastShow("‚úÖ Recibido por el servidor", 1200);
      statusText.textContent="Respuesta lista ‚úî";
    }catch(err){
      console.error(err);
      toastShow("‚ùå Error al enviar", 1500);
      statusText.textContent="Error al enviar";
    }finally{
      btnSend.disabled=false;
    }
  });
// Bot√≥n de humedad
document.getElementById('btnHumidity').addEventListener('click', async () => {
  const btn = document.getElementById('btnHumidity');
  btn.disabled = true;
  
  try {
    toastShow("Midiendo humedad...");
    
    const response = await fetch(`${SERVER}/humidity`);
    if (!response.ok) throw new Error("Error al medir");
    
    const data = await response.json();
    if (data.error) throw new Error(data.error);
    
    toastShow(`Humedad: ${data.humidity}% - ${data.message}`, 3000);
    
    // Reproducir audio
    audio.src = `${SERVER}/play?t=${Date.now()}`;
    audio.play();
    
  } catch (err) {
    toastShow(err.message || "Error al medir humedad", 2500);
    console.error(err);
  } finally {
    btn.disabled = false;
  }
});

  // Detener: corta en servidor y en el <audio>
  btnStop.addEventListener('click', async ()=>{
    try { await fetch(SERVER + "/stop", { method:"POST" }); } catch(_){}
    try { if (!audio.paused) { audio.pause(); audio.currentTime = 0; } } catch(_){}
    btnStop.disabled = true;
    toastShow("üõë Reproducci√≥n detenida", 1200);
  });

  document.addEventListener('visibilitychange', ()=>{ if(document.hidden && state==="recording"){ stopRec(); }});
  if(navigator.mediaDevices && navigator.mediaDevices.addEventListener){
    navigator.mediaDevices.addEventListener('devicechange', ()=>{
      if(state==="recording"){ stopRec(); }
      resetUI(); statusText.textContent="Audio cambi√≥. Listo para reintentar.";
    });
  }

  const blockIfButton = (e) => {
    if (e.target.closest('button, .btn')) e.preventDefault();
  };
  document.addEventListener('selectstart', blockIfButton, { passive: false });
  document.addEventListener('contextmenu', blockIfButton);

  resetUI();
</script>
</body>
</html>
